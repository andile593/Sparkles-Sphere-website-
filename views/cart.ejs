<!DOCTYPE html>
<html>

<head>
  <%- include('./partials/headInfo') %>
</head>

<body>
  <%- include('./partials/nav') %>
    <div class="product-cover">
      <div class="cart-cont">
        <div class="cart-wrap">
          <% if (carts.length===0) { %>
            <div class="empty-cart">
              <h2>Your cart is empty!!</h2>
              <button><a href="./products">Continue shopping</a></button>
            </div>
            <% } else { %>
              <div class="available-cart">
                <div class="cart-items">
                  <h1 class="cart-headline">Shopping cart</h1>
                  <% carts.forEach(cart=> { %>
                    <div class="cartItem" id="cartItem_<%= cart._id %>">
                      <img class="cart-img" src="<%= cart.image %>" alt="<%= cart.title %>">
                      <div class="cart-props">
                        <p class="cart-name">
                          <%= cart.title %>
                        </p>
                        <div class="input-wrap">
                          Quantity:
                          <button onclick="decrementQuantity(this, '<%= cart._id %>', <%= cart.price %>)">-</button>
                          <input type="number" class="quantity-input" value="<%= cart.quantity %>" min="1"
                            onchange="updateQuantity(this, '<%= cart._id %>', <%= cart.price %>)">
                          <button onclick="incrementQuantity(this, '<%= cart._id %>', <%= cart.price %>)">+</button>
                        </div>
                        <h3 class="amount cart-price" id="totalPrice_<%= cart._id %>">R<%= cart.price * cart.quantity %>
                        </h3>
                        <button onclick="removeCartItem('<%= cart._id %>')">Remove</button>
                      </div>
                    </div>
                    <% }) %>
                </div>
              </div>

              <div class="checkout-wrap">
                <h2 class="summary-title">Cart Summary</h2>
                <div class="cart-summ-wrap" id="cartSummary">
                  <% carts.forEach(cart=> { %>
                    <div class="item-props" id="summaryItem_<%= cart._id %>">
                      <p class="item">
                        <%= cart.title %>
                      </p>
                      <p>(<%= cart.quantity %>)</p>
                    </div>
                    <% }) %>
                </div>
                <span class="total-cont">Total:</span>
                <span class="total-price" id="totalPrice">R<%= totalCheckoutAmount %></span>
                <button><a href="checkout-order">Checkout</a></button>
              </div>
              <% } %>
        </div>

      </div>

      <%- include('./partials/footer') %>
    </div>
    <script src="../js/part.js"></script>
    <script>
      function incrementQuantity(btn, cartId, price) {
        const input = btn.parentElement.querySelector(".quantity-input");
        input.stepUp();
        updateQuantity(input, cartId, price);
      }

      function decrementQuantity(btn, cartId, price) {
        const input = btn.parentElement.querySelector(".quantity-input");
        input.stepDown();
        updateQuantity(input, cartId, price);
      }

      async function updateQuantity(input, cartId, price) {
        const quantity = parseInt(input.value) || 1;
        document.getElementById(`totalPrice_${cartId}`).innerText = `R${(price * quantity).toFixed(2)}`;

        try {
          const res = await fetch(`/cart/update/${cartId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quantity })
          });
          if (res.ok) {
            const data = await res.json();
            document.getElementById("totalPrice").innerText = `R${data.totalCheckoutAmount.toFixed(2)}`;
            const summaryItem = document.getElementById(`summaryItem_${cartId}`);
            if (summaryItem) summaryItem.querySelector("p:nth-child(2)").innerText = `(${quantity})`;
          }
        } catch (err) {
          console.error(err);
        }
      }

      async function removeCartItem(cartId) {
        try {
          const res = await fetch(`/cart/remove/${cartId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          if (res.ok) {
            const data = await res.json();
            document.getElementById(`cartItem_${cartId}`)?.remove();
            document.getElementById(`summaryItem_${cartId}`)?.remove();
            document.getElementById("totalPrice").innerText = `R${data.totalCheckoutAmount.toFixed(2)}`;

            if (data.totalCheckoutAmount === 0) {
              document.querySelector(".available-cart").innerHTML = `
          <div class="empty-cart">
            <h2>Your cart is empty!!</h2>
            <button><a href="./products">Continue shopping</a></button>
          </div>`;
              document.getElementById("cartSummary").innerHTML = "";
            }
          }
        } catch (err) {
          console.error(err);
        }
      }

    </script>
</body>

</html>